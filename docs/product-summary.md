# 睡眠トラッカー — プロダクトサマリー

## 概要

睡眠障害を持つユーザー向けの睡眠記録 PWA（Progressive Web App）。
スマートフォンのブラウザ上で動作し、localStorage にデータを保存する完全クライアントサイドアプリケーション。
Anthropic API を使った AI 分析機能で、睡眠パターンの振り返りと医師への情報共有を支援する。

## 一言で言うと

**「睡眠障害の当事者が、布団の中からワンタップで記録でき、AIが傾向を分析してくれる睡眠記録アプリ」**

## 解決する課題

- 既存の睡眠記録アプリはウェアラブル前提が多く、装着の負担がある
- 手動記録のアプリは操作が煩雑で、眠い状態での入力に向いていない
- 睡眠障害の診察時に客観的なデータを提示しづらい（口頭での曖昧な説明になりがち）
- 不眠症・SAS・概日リズム障害など症状ごとに注目すべき指標が異なるが、汎用アプリでは対応しきれない

## コアコンセプト

| 項目 | 内容 |
|------|------|
| プラットフォーム | PWA（スマートフォンブラウザ） |
| データ保存先 | localStorage（サーバー・DB 不要） |
| オフライン対応 | Service Worker によるキャッシュ |
| AI 連携 | Anthropic API（claude-haiku-4-5）で睡眠分析 |
| ホスティング | GitHub Pages（静的配信） |
| 対象ユーザー | 睡眠障害の当事者・通院中の患者 |

## 主な機能

### 睡眠記録（記録タブ）
- **4 段階の状態遷移**: idle → in_bed → sleeping → awake_in_bed → idle
- **長押し操作**: 眠気のある状態での誤操作を防止（SVG ドーナツリングのフィードバック付き）
- **中途覚醒サイクル**: 夜間に何度目覚めても、眠る→目覚めるを繰り返し記録
- **夜間頻尿（トイレ）記録**: 長押しでトイレ回数を記録
- **リアルタイムタイムライン**: 入床・入眠・目覚め・トイレ・離床を時系列表示、各項目の時刻修正・取消が可能
- **セッション完了サマリー**: 離床後に睡眠効率・入眠潜時・WASO などの指標を自動計算して表示

### 履歴閲覧（履歴タブ）
- 過去の記録一覧（日付・時刻・各種指標・覚醒回数・トイレ回数）
- **フラグ表示**: 概日ずれ（深夜3〜12時に入床）、活動時間帯との重複
- 詳細モーダル（タイムライン・メモ・時刻修正・削除）
- JSON エクスポート（全データダウンロード）

### 統計・AI 分析（統計タブ）
- **期間切り替え**: 7日間 / 14日間 / 30日間
- **集計統計**: 平均睡眠時間・床上時間・睡眠効率・入眠潜時・覚醒回数・夜間頻尿
- **棒グラフ**: 睡眠時間の推移（睡眠 vs 覚醒のスタックバー）
- **AI 分析**: ユーザーの症状・活動時間帯をコンテキストに含めた分析レポートを生成
- **医師向けレポート**: 集計＋全記録をプレーンテキストで生成し、`navigator.share` で共有

### 設定（設定タブ）
- **症状・傾向チェックリスト**: 4カテゴリ 11症状（AI 分析のコンテキストに反映）
- **活動時間帯**: 曜日ごとに ON/OFF と時刻を設定（履歴フラグ・AI 分析に使用）

## 技術スタック

| 項目 | 技術 |
|------|------|
| フロントエンド | Vanilla HTML / CSS / JavaScript（フレームワーク不使用） |
| PWA | Service Worker（キャッシュファースト戦略） |
| データ永続化 | localStorage |
| AI 分析 | Anthropic API（claude-haiku-4-5-20251001） |
| ホスティング | GitHub Pages |
| ビルドツール | なし（ビルドレス） |
| テスト | なし（プロトタイプ段階） |

## アーキテクチャ

```
sleep-tracker/
├── index.html              # SPA エントリーポイント（4タブ + モーダル）
├── js/
│   └── app.js              # アプリケーション全体のロジック（状態管理・UI・API連携）
├── css/
│   └── style.css           # スタイル（ダークテーマ・モバイルファースト）
├── sw.js                   # Service Worker（オフライン対応・キャッシュ管理）
├── manifest.json           # PWA マニフェスト
├── icons/                  # アプリアイコン（180/192/512px）
└── docs/                   # ドキュメント
    ├── history.md           # ユーザー視点の変更履歴
    └── ideas/               # 検討中のアイデア
```

### app.js の内部構成

| セクション | 役割 |
|-----------|------|
| DB Object | localStorage の読み書き・エクスポート |
| App State | グローバル状態管理（currentSession, sessions, UI状態） |
| Session State Logic | 状態マシン（idle / in_bed / sleeping / awake_in_bed） |
| Action Functions | ボタン操作に対応するアクション（bedTime, sleep, wake, toilet, outOfBed） |
| Time Calculations | 睡眠指標の計算（睡眠効率・入眠潜時・WASO など） |
| UI Rendering | 各タブ・モーダルのDOM構築・更新 |
| AI Analysis | Anthropic API 呼び出し・プロンプト構築・結果表示 |
| Settings | 症状・活動時間帯の保存・読み出し |
| Long Press | カスタム長押しハンドラ（SVGドーナツリング + バイブレーション） |

## データ構造

```js
// localStorage['sleep-tracker-v1']
{
  currentSession: Session | null,   // 進行中の記録
  sessions: Session[]               // 完了済み（新しい順）
}

// Session
{
  id: "s_<timestamp>",
  bedTime: ISO string,              // 入床時刻
  outOfBedTime: ISO string | null,  // 離床時刻
  cycles: [                         // 睡眠-覚醒サイクル（複数回）
    { sleepTime: ISO string, wakeTime: ISO string | null }
  ],
  toiletTrips: ISO string[],        // トイレ時刻の配列
  notes: string                     // メモ
}
```

## 数値・規模感

| 指標 | 値 |
|------|-----|
| バージョン | プロトタイプ（v0.x 相当） |
| ソースファイル数 | 5（HTML / JS / CSS / SW / manifest） |
| 合計コード行数 | 約 3,500 行 |
| コミット数 | 50 |
| テスト数 | 0（プロトタイプのため） |
| 外部依存 | 0（ビルドツール・ライブラリなし） |
| ライセンス | 未設定 |

## 差別化ポイント

1. **睡眠障害特化** — 不眠症・SAS・概日リズム障害・起立性調節障害など、症状ごとのコンテキストを AI 分析に反映。汎用睡眠アプリにはない専門性
2. **ウェアラブル不要** — スマホのブラウザだけで完結。装着の負担やデバイス購入が不要
3. **眠い状態での操作設計** — 長押し＋ドーナツリングで誤操作防止。最小限のタップで記録完了
4. **医師向けレポート** — 診察時にそのまま共有できるテキストレポートを自動生成
5. **完全ローカル** — アカウント登録不要。データは端末内に保持。プライバシーを完全に確保
6. **ゼロ依存** — フレームワーク・ビルドツール・外部サービスなし。GitHub Pages で静的配信のみ
7. **PWA** — ホーム画面に追加してネイティブアプリのように使える。オフラインでも動作

## 対象ユーザーと利用シーン

| ユーザー | シーン |
|---------|-------|
| 不眠症の通院患者 | 毎晩の記録を診察時に医師へ共有 |
| 概日リズム障害の当事者 | 生活リズムの乱れを可視化・AI で傾向把握 |
| SAS（睡眠時無呼吸）の患者 | 夜間覚醒・トイレ回数を客観的に記録 |
| 起立性調節障害の学生 | 活動時間帯との重複を把握し、学校との調整材料に |

## 今後の可能性

- **クラウド同期**: 端末間のデータ共有（Supabase 等のバックエンド追加）
- **アラーム・リマインダー**: 活動時間帯に基づく起床通知
- **他ユーザー共有**: 家族・パートナーへの記録共有機能
- **データ分析の高度化**: 長期トレンド分析・季節変動の検出
- **サービス化**: マルチユーザー対応・サブスクリプションモデル（Next.js + Supabase + Stripe）
- **医療機関連携**: 電子カルテへのデータ連携の可能性
