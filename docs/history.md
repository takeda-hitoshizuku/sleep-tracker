# 変更履歴

## 2026-02-26

### GitHub push 用セッション起動フックを追加

`.claude/hooks/session-start.sh` を追加。新セッション開始時に自動で `github` リモートと `push-github` エイリアスを設定するようになった。
トークンは `.claude/github-token` に保存（`.gitignore` で git 管理外）。



### アクションボタンに長押し操作を追加

スクロール中の誤操作防止のため、センシティブなボタンを長押し（350ms）で発火するように変更。

- **長押し対象**: 眠る（推定）・目覚めた・トイレ
- **タップのまま**: 布団に入る・布団から出る（意図的なアクションなので誤爆リスクが低い）
- **ドーナツリングインジケータ**: 長押し中に SVG のリングが円周に沿って塗り埋まっていく
- 完了時に短いバイブレーションフィードバック
- デスクトップ（非タッチ）では従来通りクリックで発火

---

このファイルはアプリの機能追加・修正の記録です。
コミット粒度ではなく「ユーザーから見た変化」単位でまとめています。

---

## 2026-02-26

### 活動時間帯スケジュール機能を追加

- **設定タブ（⚙️）を新設**
  - 曜日ごとに「活動時間帯」（起きていなければならない時間帯）を ON/OFF＋開始・終了時刻で設定
  - `localStorage` に `sleep-tracker-schedule` キーで保存

- **重複フラグの表示**
  - 履歴ビュー: 活動時間帯と重複するセッションに `活動時間帯` バッジを赤字で表示
  - 医師向けレポート: 集計欄に「活動時間帯と重複: N回 / M件中」を追加

- **AI プロンプトへのスケジュール文脈**
  - 設定済みスケジュールをプロンプト冒頭に渡す
  - 重複セッションに `★活動時間帯と重複` タグを付与してAIが把握しやすくする

### タイムラインに「取消」ボタンを追加

- **眠る（推定）の取消**: サイクルをまるごと削除（`s.cycles.splice`）
- **目覚めたの取消**: `cycle.wakeTime = null` に戻し「眠り中」状態に戻す
- トイレに続き、睡眠・覚醒エントリにも取消ボタンが並ぶ統一UIになった

### PWA アップデートバナーが表示されない不具合を修正

- `controllerchange` リスナーを `window.addEventListener('load', ...)` の**外**に移動
- SW の `skipWaiting()` がページロード前に発火した場合にイベントを取り逃していた問題を解消

### ホーム画面レイアウト変更

- タイムラインとアクションボタンエリアの表示順を入れ替え（ボタン → タイムライン の順）

### iOS CSS 対応知見を CLAUDE.md に追記

- `input[type="time"]` の幅オーバー対策（`-webkit-appearance: none`）
- `overflow-y: auto` と子要素の幅崩れ対策
- SW キャッシュバージョン更新ルールの明文化

---

## 2026-02-26（セッション前半）

### PWA アップデート検知バナーを追加

- SW の `controllerchange` イベントで新バージョン検知 → 「再読み込み」バナーを画面上部に表示
- `sw.js` `CACHE_NAME` を v5 → v14 に更新

### iOS input 幅オーバー修正（試行錯誤）

以下の順で対応を試みた。最終的に `-webkit-appearance: none` が確実だと分かった。

| 試行 | 手法 | 結果 |
|------|------|------|
| 1 | フォントサイズ 16px | 改善なし |
| 2 | `datetime-local` → `date` + `time` に分割 | 部分改善 |
| 3 | `overflow-y: auto` を `hidden` に変更 | 部分改善 |
| 4 | `contain: paint` | 効果なし |
| 5 | `clip-path: inset(0)` | 効果なし |
| 6 | `-webkit-appearance: none` | **解決** |

### 履歴ビューの時刻編集モーダルが詳細モーダルの裏に隠れる問題を修正

- 編集モーダルの `z-index` を詳細モーダルより高く設定

---

## 2026-02-21

### AI 分析・医師向けレポート機能を追加

- Anthropic API キー設定 → 統計ビューから「この N 日間を分析する」ボタンで呼び出し
- `claude-haiku-4-5` モデルで睡眠記録を分析、Markdown で表示
- 医師向けテキストレポート（コピー用）を生成する機能を追加

### フロー改善

- 「目覚めた」ボタンを常時表示する設計に変更
- 「眠る（推定）」ボタンを眠れなかった場合にも利用しやすいよう改善
- 布団から出た後でも入眠時刻をタイムラインから修正できるように対応

### トイレ（夜間頻尿）記録機能を追加

- セッション中にトイレ回数を記録
- 統計・医師レポートに夜間頻尿回数を含める

### バグ修正

- 「眠れなかった場合の布団から出る」が機能しない問題を修正

---

## 2026-02-21（初回リリース）

### PWA 睡眠トラッカーを新規作成

対象症状: 不眠症・SAS・概日リズム睡眠障害・起立性調整障害

**主要機能:**
- 入床 → 眠る（推定）→ 目覚める → 離床 の4ステップ記録
- 複数回の中途覚醒サイクルに対応
- 睡眠効率・入眠潜時・WASO・覚醒回数の自動計算
- 統計グラフ（7/14/30日）
- PWA 対応（オフライン動作、ホーム画面追加）
- GitHub Pages でホスティング
