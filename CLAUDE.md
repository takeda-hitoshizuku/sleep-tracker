# アプリ仕様

> **この章は画面・機能が変わるたびに更新すること。**
> Claude はセッションをまたぐと記憶がリセットされるため、ここが唯一の引継ぎ情報になる。

## 概要

睡眠記録 PWA（スマートフォン専用）。
localStorage にデータを保存し、Anthropic API を使った AI 分析機能を持つ。

## 画面構成（ボトムナビ 4 タブ）

### 記録タブ（🌙 記録）
メインの記録操作画面。

**ステータスカード**
- 現在の睡眠状態とアイコン・経過時間をリアルタイム表示

**記録状態と遷移**

```
idle（就寝前）
  → [布団に入る] → in_bed（布団の中・覚醒中）
      → [眠る 長押し]   → sleeping（睡眠中）
          → [目覚めた 長押し] → awake_in_bed（覚醒中・布団）
              → [また眠る 長押し] → sleeping（繰り返し）
              → [起床・布団から出る] → idle（記録完了）
      → [目覚めた 長押し] → awake_in_bed（入眠時刻は後で修正）
      → [布団から出る] → idle（眠れなかった記録）
```

**アクションボタン**（状態ごとに表示が変わる）
- `布団に入る` / `眠る（推定）` / `また眠る（推定）`：長押し（ドーナツリングアニメーション付き）
- `目覚めた` / `また目覚めた`：長押し
- `トイレ`：長押し（夜間頻尿の記録）
- `布団から出る` / `起床・布団から出る`：タップ

**今夜のタイムライン**
- 入床・入眠・目覚め・トイレ・離床を時系列表示
- 各項目に「修正」ボタン（時刻編集モーダルを開く）・「取消」ボタン

**セッション完了サマリー**
- 離床ボタン押下後に表示
- 床上時間・総睡眠時間・入眠潜時・中途覚醒・睡眠効率バー
- タイムラインも表示（ここでも時刻修正可能）

---

### 履歴タブ（📋 履歴）
過去の睡眠記録一覧。

- 日付・入床〜離床時刻・床上時間・総睡眠時間・睡眠効率・覚醒回数・トイレ回数
- フラグ表示：`概日ずれ`（深夜3〜12時に入床）、`活動時間帯`（設定した活動時間帯と重複）
- エクスポートボタン（全データを JSON でダウンロード）
- タップで詳細モーダルを開く

**詳細モーダル**
- 各種指標（床上時間・睡眠時間・効率・入眠潜時・WASO・夜間頻尿など）
- タイムライン（時刻修正・取消可能）
- メモ入力欄（自動保存）
- 記録削除ボタン

---

### 統計タブ（📊 統計）
過去の集計・AI 分析。

**期間タブ**：7日間 / 14日間 / 30日間

**集計統計**（期間切り替えで更新）
- 平均睡眠時間・床上時間・睡眠効率・入眠潜時・覚醒回数・夜間頻尿

**AI 分析**
- APIキー未設定時：入力欄を表示
- APIキー設定済み：「この○日間を分析する」ボタンで任意に実行
- 結果表示後：「コピー」「再分析」「APIキーを変更」ボタン
- モデル：`claude-haiku-4-5-20251001`
- システムプロンプト：設定の症状・活動時間帯をコンテキストとして渡す
- 出力フォーマット：`## 今日の記録` / `## ひとこと` / `## 気になること`（任意）/ `## おすすめ`（任意）

**医師向けレポート**
- 集計統計＋全記録をプレーンテキストで生成
- `navigator.share` で共有（非対応時はクリップボードコピー）

---

### 設定タブ（⚙️ 設定）
アコーディオン形式（1つ開くと他は閉じる）。

**症状・傾向**（AI 分析のコンテキストに使用）
| グループ | 項目 |
|---------|------|
| 寝れない系 | 不眠症・入眠困難・中途覚醒・早朝覚醒 |
| 起きれない系 | 過眠症・起立性調節障害・睡眠慣性 |
| 不規則・昼夜逆転系 | 概日リズム睡眠障害・睡眠相後退症候群・交代勤務 |
| その他 | SAS（睡眠時無呼吸症候群）・むずむず脚症候群 |

**活動時間帯**（履歴・AI 分析のフラグ判定に使用）
- 曜日ごとに ON/OFF と開始〜終了時刻を設定
- デフォルト時刻：09:00〜18:00

---

## モーダル

| モーダル | 用途 |
|---------|------|
| 時刻編集モーダル | 入床・入眠・目覚め・離床の時刻を日付＋時刻ピッカーで修正 |
| 確認ダイアログ | 時刻編集モーダルを流用（入力欄を非表示にして OK/キャンセルのみ表示） |
| 詳細モーダル | 履歴一覧からタップで開く。統計・タイムライン・メモ・削除 |

---

## データ構造

```js
// localStorage キー: 'sleep-tracker-v1'
{
  currentSession: Session | null,
  sessions: Session[]       // 完了済み（新しい順）
}

// Session
{
  id: string,               // 's_' + timestamp
  bedTime: ISO string,
  outOfBedTime: ISO string | null,
  cycles: [
    { sleepTime: ISO string, wakeTime: ISO string | null }
  ],
  toiletTrips: ISO string[],
  notes: string
}

// 設定（それぞれ別キー）
localStorage['sleep-tracker-claude-key']  // Anthropic API キー
localStorage['sleep-tracker-symptoms']    // 選択済み症状 ID の配列（JSON）
localStorage['sleep-tracker-schedule']    // { [曜日番号]: { start: 'HH:MM', end: 'HH:MM' } }
```

---

# プロジェクト方針

## コミュニケーション

**ユーザーへのメッセージはすべて日本語で書くこと。**

## ドキュメント管理

プロジェクトの記録は `docs/` 以下に置く。

| ファイル | 内容 |
|----------|------|
| `docs/history.md` | 機能追加・修正の変更履歴（コミット粒度ではなく「ユーザーから見た変化」単位） |
| `docs/ideas/*.md` | 今後実装したい・検討中のアイデア（1テーマ1ファイル） |

### 運用ルール

- 機能を実装・修正したら **`docs/history.md` の先頭に追記する**
- 実装を見送った機能は `docs/ideas/<テーマ名>.md` に残す
- CLAUDE.md はプロジェクト方針・開発時のお作法のみ記載する（変更履歴は書かない）

## ターゲット環境

**スマートフォン（モバイル）のみを対象として開発する。**

- PC・デスクトップ向けのレイアウト調整は現時点では行わない
- タップ操作を前提とした UI 設計を優先する
- 画面サイズはスマートフォンの縦持ちを基準とする

## ブランチ運用

- 作業ブランチで開発し、完了後は `main` に直接プッシュする
- 作業開始時に `git log --all --graph` でブランチの状態を確認する

## 開発フロー（プロトタイプ方針）

**このプロジェクトはプロトタイプ開発のため、機能の実装が完了したら即座に `main` へマージし GitHub Pages を最新の状態に保つ。**

- 機能実装完了 → `git push-github` で GitHub Pages に反映
- 「完了」の定義: 動作確認が取れた状態。完璧でなくてよい
- レビュー待ちやドラフト状態で止めない
- `docs/history.md` の先頭に変更内容を追記してから push する

## GitHub へのプッシュ（main 反映）

ローカルプロキシは `claude/*` 以外への push を 403 でブロックするため、
GitHub への直接プッシュには `github` リモートを使う。

```bash
# 通常のプッシュ（.claude/ を GitHub に送らない安全なエイリアス）
git push-github

# または手動でブランチを指定してプッシュ
git push github main
```

**重要**: `.claude/` ディレクトリには PAT を含む認証情報が入っている。
`git push-github` エイリアスは `.claude/` を除いたツリーを GitHub に送るため安全。
`git push github main` で直接送ると `.claude/` ごと行くので注意。

セッション開始時に `.claude/hooks/session-start.sh` が自動で
`github` リモートと `push-github` エイリアスをセットアップする。

## iOS Safari / Chrome の CSS 注意事項

### input 要素の幅オーバー問題

iOS のネイティブ form コントロール（`date`, `time`, `datetime-local` 等）は、
CSS の `overflow: hidden` や `contain: paint` だけでは幅を制御できない場合がある。

**必須対応：**

```css
input[type="date"],
input[type="time"],
input[type="datetime-local"] {
  -webkit-appearance: none;
  appearance: none;       /* ネイティブ描画を無効化 → CSS で幅を完全制御 */
  width: 100%;
  box-sizing: border-box;
}
```

- `datetime-local` は iOS で幅が広くなりやすいため、`date` + `time` に分割して縦並びにする方が安全
- PC Chrome の DevTools モバイルエミュレーションでは再現しない（実機 iOS でのみ発生）

### `overflow-y: auto` と子要素の幅

iOS WebKit では、親要素に `overflow-y: auto` を設定すると
子要素の `width: 100%` がパディングを無視して計算されることがある。

```css
/* NG: 子要素が親のパディング分だけ幅オーバーする */
.parent {
  padding: 20px;
  overflow-y: auto;
}

/* OK: overflow は hidden にするか、内側にラッパーを置く */
.parent {
  padding: 20px;
  overflow: hidden; /* または overflow-y: auto を使わない */
}
```

### Service Worker のキャッシュ更新

CSS を変更するたびに `sw.js` の `CACHE_NAME` バージョンを上げる。
上げないと iOS はキャッシュを使い続けて変更が反映されない。
