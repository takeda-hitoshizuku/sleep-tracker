# 睡眠トラッカー サービス化計画

## 1. なぜサブスクとして成立するか

### 競合との差別化

| サービス | 問題点 |
|---|---|
| Apple ヘルスケア | 入力まで辿りつきにくい。「布団に入る」「眠る」「目覚める」の区別がない |
| Sleep Cycle | 自動計測ベースで、睡眠障害特有の複雑なパターンに対応できない |
| 一般睡眠アプリ | 健常者向け設計。医師に提出するデータとして不十分 |

### このアプリが持つ固有の強み

- **布団に入る → 眠る → 目覚める → 布団から出る** の4フェーズを明示的に記録
- 途中覚醒・頻尿（夜間排尿）を個別にタイムスタンプ記録
- 睡眠潜時（入眠までの時間）・WASO（途中覚醒時間）を自動算出
- 不眠症・SAS・概日リズム睡眠障害・起立性調整障害に対応した設計
- 医師向けレポート出力機能（既実装）
- AI分析機能（既実装）

### ターゲット

睡眠専門外来に通う・通ったことのある患者。睡眠日誌の記録を続ける動機が強く、医師への提出というユースケースが明確。

---

## 2. 現在の技術構成

```
sleep-tracker/
├── index.html      # 単一ページ
├── js/app.js       # 全ロジック（1500行、vanilla JS）
├── css/
├── manifest.json   # PWA設定
└── sw.js           # Service Worker
```

- **データ**: LocalStorage のみ（デバイス外に出ない）
- **AI分析**: ユーザーが自分のAPIキーをブラウザに入力して直接呼出し
- **認証**: なし
- **課金**: なし

---

## 3. サービス化後の構成

### 追加するレイヤー

| 役割 | 採用技術 | 理由 |
|---|---|---|
| フロントエンド | Next.js（App Router）+ PWA | 既存vanilla JSを移植しやすく、API Routesも使える |
| 認証 | Supabase Auth | メール/パスワード + マジックリンク対応。実装コスト低 |
| データベース | Supabase（PostgreSQL） | RLS（行レベルセキュリティ）でマルチテナントを簡潔に実現 |
| AI分析API | Next.js API Routes | Claude APIキーをサーバー側に隠蔽 |
| 決済 | Stripe Checkout | PWAとの相性◎。サブスク管理が容易 |
| ホスティング | Vercel | Next.js と親和性が高く、HTTPS自動 |

### データモデル（概要）

```
users
  id, email, stripe_customer_id, created_at

subscriptions
  user_id, status, plan, current_period_end

sleep_sessions
  id, user_id, bed_time, out_of_bed_time, notes,
  created_at, encrypted_data

sleep_cycles
  id, session_id, sleep_time, wake_time

toilet_trips
  id, session_id, time
```

---

## 4. セキュリティ・データ保護

### 暗号化 vs ハッシュ化

| 用途 | 手法 | 理由 |
|---|---|---|
| パスワード | Argon2ハッシュ | 一方向。復元不要。Supabase Authが自動処理 |
| 睡眠データ | AES-256暗号化（保存時） | 読み書きが必要なので復元できる必要がある |
| 通信 | HTTPS（TLS） | Vercelで自動適用 |

### マルチテナントの分離

Supabase の **Row Level Security (RLS)** により、SQLレベルで「自分のデータしか取得できない」を強制。アプリ側のバグでも他ユーザーのデータは漏れない。

```sql
-- 例: sleep_sessionsへのRLSポリシー
CREATE POLICY "自分のセッションのみ参照可"
  ON sleep_sessions FOR ALL
  USING (user_id = auth.uid());
```

---

## 5. 機能のサブスク区分

| 機能 | 無料 | 有料（サブスク） |
|---|---|---|
| 睡眠記録（記録・タイムライン） | ✅ | ✅ |
| 履歴閲覧（直近7日） | ✅ | ✅ |
| 統計（直近7日） | ✅ | ✅ |
| 全期間の履歴・統計 | — | ✅ |
| AI分析 | — | ✅（APIキー不要） |
| 医師向けレポート生成 | — | ✅ |
| デバイス間同期 / クラウドバックアップ | — | ✅ |
| データエクスポート（CSV/JSON） | ✅ | ✅ |

> 無料枠を設けることで、外来からの紹介後に試してもらいやすくする。

---

## 6. 料金設計（案）

| プラン | 価格 | 対象 |
|---|---|---|
| 無料 | ¥0 | まず試したい人 |
| 月払い | ¥680/月 | 様子見ながら続けたい人 |
| 年払い | ¥5,800/年（¥483/月相当） | 長期通院中の患者 |

---

## 7. 開発フェーズ

### Phase 1 — 基盤構築
- Next.js + Supabase Auth + DB 導入
- 既存app.jsのロジックを移植
- LocalStorage → DB への移行（データエクスポート/インポート機能で橋渡し）
- Vercel デプロイ

### Phase 2 — サブスク実装
- Stripe Checkout 統合
- プラン判定ロジック（機能の出し分け）
- AI分析のサーバーサイド化（APIキー内部化）

### Phase 3 — 医療機関連携
- 患者が医師に共有できる「閲覧専用リンク」生成
- 医師ダッシュボード（担当患者の記録一覧）
- 医療機関向けプラン（患者への紹介フロー）

---

## 8. 睡眠専門外来へのアプローチ

### なぜクリニックと組むべきか

- **信頼コストゼロ**: 医師が勧めるアプリという事実が、患者の最大の不安（データ・信頼性）を解消する
- **獲得コストゼロ**: 外来患者に紹介してもらえれば、広告費なしに動機の高いユーザーが集まる
- **クリニック側のメリット**: 患者の睡眠日誌管理が電子化され、診察時間が有効活用できる

### アプローチ方法（案）

1. まず自分が通院していたクリニックに声をかける
2. **医師が無料で患者に試させられる紹介コード**を発行
3. 導入実績ができたら他のクリニックへ横展開
4. 将来的に「医療機関向け月額プラン（患者数✕単価）」へ

---

## 9. 技術スタック まとめ

```
フロントエンド: Next.js 15 (App Router) + Tailwind CSS
PWA:           next-pwa または @ducanh2912/next-pwa
認証:           Supabase Auth
データベース:   Supabase (PostgreSQL + RLS)
AIバックエンド: Next.js API Routes → Anthropic Claude API
決済:           Stripe (Checkout + Webhooks)
ホスティング:   Vercel
CI/CD:         GitHub Actions（Vercel自動デプロイ）
```

---

## 10. 懸念点と対策

| 懸念 | 対策 |
|---|---|
| 医療情報としての規制 | 「医療機器」ではなく「健康管理ツール」の位置づけで運用。記録は参考情報とする旨を明示 |
| サービス停止時のデータ | CSVエクスポートを常時無料で提供。ユーザーが自分のデータを持ち出せる状態を保つ |
| Supabase依存 | データは定期的にバックアップ。将来的に自前PostgreSQLへ移行可能な設計にする |
| サブスク解約後のデータ | 解約後も一定期間（例: 90日）はデータを保持。再課金で復活できる |
